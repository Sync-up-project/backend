generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//
// Enums
//
enum Language {
  KO
  EN
  JA
}

enum UserRole {
  PLANNER
  DEV
  DESIGN
}

enum TechLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum PositionType {
  PLANNER
  DEV
  DESIGN
}

enum ProjectMode {
  ONLINE
  OFFLINE
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

enum ChatRoomType {
  PROJECT_GROUP
  DIRECT
}

enum KanbanCardStatus {
  TODO
  IN_PROGRESS
  DONE
}

//
// ✅ 추가 Enums (OAuth / Repo / AI / Summary / Audit)
//
enum AuthProvider {
  GITHUB
  GOOGLE
  // 필요 시 확장
}

enum RepoProvider {
  GITHUB
}

enum AiArtifactType {
  PRD
  WBS
  ERD
  API_SPEC
  SCREEN_LIST
  DECISION_LOG
  OTHER
}

enum SummarySource {
  CHAT
  MEETING
  COMMITS
  MANUAL
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ARCHIVE
}

//
// ✅ 추가: 서비스 권한(인증/인가)용 Role
// 기존 UserRole(PLANNER/DEV/DESIGN)은 "포지션" 성격이라 그대로 두고,
// 로그인/권한 분리를 위해 별도 enum을 추가합니다.
//
enum AccountRole {
  USER
  ADMIN
}

//
// Models
//
model User {
  id              String    @id @default(cuid())

  // ✅ GitHub OAuth에서는 email이 없을 수 있어 nullable 권장
  // (GitHub email 비공개, 또는 scope/설정에 따라 제공되지 않을 수 있음)
  email           String?   @unique

  // ✅ OAuth 가입 유저는 password가 없으므로 nullable
  passwordHash    String?

  nickname        String?
  profileImageUrl String?
  bio             String?
  primaryLanguage Language  @default(KO)

  // 기존 포지션(PLANNER/DEV/DESIGN) 필드는 유지 (nullable 권장: 가입 직후 미정 가능)
  role            UserRole?

  // ✅ 인증/인가용 서비스 역할(권한)
  accountRole     AccountRole @default(USER)

  githubUsername  String?
  githubUrl       String?
  githubCommits   Int?
  githubRepoCount Int?
  githubTopLangs  Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  techStacks            UserTechStack[]
  ownedProjects         Project[]           @relation("ProjectOwner")
  memberships           ProjectMember[]
  sentInvitations       Invitation[]        @relation("InvitationInviter")
  receivedInvitations   Invitation[]        @relation("InvitationInvitee")
  applications          Application[]
  chatMessages          ChatMessage[]
  chatRoomMembers       ChatRoomMember[]
  evaluationsGiven      ProjectEvaluation[] @relation("EvaluationGiver")
  evaluationsReceived   ProjectEvaluation[] @relation("EvaluationReceiver")
  badges                UserBadge[]
  notifications         Notification[]
  kanbanCardAssignments KanbanCardAssignee[]

  // ✅ OAuth 연동 계정/토큰 관리
  oauthAccounts          OAuthAccount[]

  // ✅ Refresh 세션(쿠키 기반 refresh 토큰을 DB에서 폐기/관리하기 위함)
  refreshSessions        RefreshSession[]

  // ✅ 추가: 캘린더/시간추적
  calendarEventAssignees ProjectCalendarEventAssignee[]
  createdCalendarEvents  ProjectCalendarEvent[] @relation("ProjectCalendarEventCreator")
  timeEntries            TimeEntry[]

  // ✅ 추가: AI 산출물/요약/감사로그(행위자)
  aiArtifactsCreated     AiArtifact[]      @relation("AiArtifactCreator")
  summariesCreated       ProjectSummary[]  @relation("ProjectSummaryCreator")
  auditLogs              AuditLog[]        @relation("AuditActor")

  @@index([role])
  @@index([primaryLanguage])
  @@index([accountRole])
}

model TechStack {
  id        String   @id @default(cuid())
  name      String   @unique
  iconUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    UserTechStack[]
  projects ProjectTechStack[]

  @@index([name])
}

model UserTechStack {
  id          String    @id @default(cuid())
  userId      String
  techStackId String
  level       TechLevel @default(INTERMEDIATE)
  years       Int?      // optional: 경력(년)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  techStack TechStack @relation(fields: [techStackId], references: [id], onDelete: Cascade)

  @@unique([userId, techStackId])
  @@index([userId])
  @@index([techStackId])
}

model Project {
  id                  String        @id @default(cuid())
  ownerId             String
  originalLang        Language
  titleOriginal       String
  summaryOriginal     String
  descriptionOriginal String
  mode                ProjectMode   @default(ONLINE)
  difficulty          Difficulty    @default(MEDIUM)
  status              ProjectStatus @default(PLANNING)
  capacity            Int           @default(1)
  deadline            DateTime?
  startDate           DateTime?
  endDate             DateTime?
  likeCount           Int           @default(0)
  viewCount           Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  owner          User                 @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  i18n           ProjectI18n[]
  techStacks     ProjectTechStack[]
  positionNeeds  ProjectPositionNeed[]
  members        ProjectMember[]
  invitations    Invitation[]
  applications   Application[]
  chatRoom       ChatRoom?
  kanbanBoard    KanbanBoard?
  successStories ProjectSuccessStory[]
  evaluations    ProjectEvaluation[]

  // ✅ 추가: 프로젝트 ↔ 레포지토리 연결
  repositories   ProjectRepository[]

  // ✅ 추가: 캘린더/시간추적
  calendarEvents ProjectCalendarEvent[]
  timeEntries    TimeEntry[]

  // ✅ 추가: AI 산출물/요약/감사로그
  aiArtifacts    AiArtifact[]
  summaries      ProjectSummary[]
  auditLogs      AuditLog[]

  @@index([ownerId])
  @@index([mode])
  @@index([difficulty])
  @@index([status])
  @@index([deadline])
  @@index([createdAt])
}

model ProjectI18n {
  id          String   @id @default(cuid())
  projectId   String
  lang        Language
  title       String
  summary     String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, lang])
  @@index([projectId])
  @@index([lang])
}

model ProjectTechStack {
  id          String   @id @default(cuid())
  projectId   String
  techStackId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  techStack TechStack @relation(fields: [techStackId], references: [id], onDelete: Cascade)

  @@unique([projectId, techStackId])
  @@index([projectId])
  @@index([techStackId])
}

model ProjectPositionNeed {
  id        String       @id @default(cuid())
  projectId String
  position  PositionType
  headcount Int          @default(1)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, position])
  @@index([projectId])
  @@index([position])
}

model ProjectMember {
  id            String   @id @default(cuid())
  projectId     String
  userId        String
  roleInProject String?
  joinedAt      DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Invitation {
  id        String       @id @default(cuid())
  projectId String
  inviterId String
  inviteeId String
  status    InviteStatus @default(PENDING)
  message   String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter User    @relation("InvitationInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User    @relation("InvitationInvitee", fields: [inviteeId], references: [id], onDelete: Cascade)

  // 다국어 초대 알림/메일 컨텐츠 (미리 저장)
  notifications Notification[]

  @@unique([projectId, inviteeId])
  @@index([projectId])
  @@index([inviterId])
  @@index([inviteeId])
  @@index([status])
}

model Application {
  id          String            @id @default(cuid())
  projectId   String
  applicantId String
  status      ApplicationStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  applicant User    @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@unique([projectId, applicantId])
  @@index([projectId])
  @@index([applicantId])
  @@index([status])
}

//
// Notifications (초대/지원/프로젝트 관련 알림: 미리 번역 저장 가능)
//
model Notification {
  id            String   @id @default(cuid())
  userId        String
  invitationId  String?  // 초대 기반 알림이면 연결
  type          String   // "INVITE", "INVITE_STATUS", "PROJECT_UPDATE" 등 (초기엔 String)
  isRead        Boolean  @default(false)

  // 원문 + i18n (조회 시 번역 금지)
  originalLang  Language
  titleOriginal String
  bodyOriginal  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitation Invitation? @relation(fields: [invitationId], references: [id], onDelete: Cascade)
  i18n       NotificationI18n[]

  @@index([userId])
  @@index([invitationId])
  @@index([isRead])
  @@index([createdAt])
}

model NotificationI18n {
  id             String   @id @default(cuid())
  notificationId String
  lang           Language
  title          String
  body           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, lang])
  @@index([notificationId])
  @@index([lang])
}

//
// Chat (프로젝트 그룹 + 1:1 모두 지원)
//
model ChatRoom {
  id        String       @id @default(cuid())
  type      ChatRoomType @default(PROJECT_GROUP)

  // 프로젝트 그룹 채팅이면 projectId 사용 (프로젝트당 1개)
  projectId String?      @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project  Project?        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  members  ChatRoomMember[]
  messages ChatMessage[]

  @@index([type])
}

model ChatRoomMember {
  id        String   @id @default(cuid())
  roomId    String
  userId    String
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
}

model ChatMessage {
  id           String   @id @default(cuid())
  roomId       String
  senderId     String
  originalText String
  originalLang Language
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  i18n   ChatMessageI18n[]

  @@index([roomId])
  @@index([senderId])
  @@index([createdAt])
}

model ChatMessageI18n {
  id             String   @id @default(cuid())
  messageId      String
  targetLang     Language
  translatedText String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, targetLang])
  @@index([messageId])
  @@index([targetLang])
}

//
// 프로젝트 팀 구성 즉시 자동 생성되는 구조
//
model KanbanBoard {
  id        String   @id @default(cuid())
  projectId String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  columns KanbanColumn[]
}

model KanbanColumn {
  id        String   @id @default(cuid())
  boardId   String
  title     String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board KanbanBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  cards KanbanCard[]

  @@unique([boardId, position])
  @@index([boardId])
}

model KanbanCard {
  id          String           @id @default(cuid())
  columnId    String
  title       String
  description String?
  status      KanbanCardStatus @default(TODO)
  dueDate     DateTime?
  position    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  column    KanbanColumn         @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignees KanbanCardAssignee[]

  // ✅ 추가: 시간추적(TimeEntry)에서 연결 가능
  timeEntries TimeEntry[]

  @@unique([columnId, position])
  @@index([columnId])
  @@index([status])
}

model KanbanCardAssignee {
  id     String @id @default(cuid())
  cardId String
  userId String

  card KanbanCard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([cardId, userId])
  @@index([cardId])
  @@index([userId])
}

//
// Project Evaluation / Trust
//
model ProjectEvaluation {
  id            String   @id @default(cuid())
  projectId     String
  evaluatorId   String
  evaluateeId   String
  diligence     Int      // 1~5
  communication Int      // 1~5
  contribution  Int      // 1~5
  comment       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  evaluator User    @relation("EvaluationGiver", fields: [evaluatorId], references: [id], onDelete: Cascade)
  evaluatee User    @relation("EvaluationReceiver", fields: [evaluateeId], references: [id], onDelete: Cascade)

  @@unique([projectId, evaluatorId, evaluateeId])
  @@index([projectId])
  @@index([evaluatorId])
  @@index([evaluateeId])
}

model Badge {
  id        String   @id @default(cuid())
  code      String   @unique // 예: "GOOD_COMMUNICATION"
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

//
// Trends + Success Stories
//
model TrendArticle {
  id              String   @id @default(cuid())
  originalLang    Language
  titleOriginal   String
  summaryOriginal String
  sourceName      String
  sourceUrl       String   @unique
  publishedAt     DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  i18n TrendArticleI18n[]

  @@index([publishedAt])
  @@index([originalLang])
}

model TrendArticleI18n {
  id        String   @id @default(cuid())
  articleId String
  lang      Language
  title     String
  summary   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article TrendArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, lang])
  @@index([articleId])
  @@index([lang])
}

model ProjectSuccessStory {
  id              String   @id @default(cuid())
  projectId        String
  originalLang     Language
  titleOriginal    String
  contentOriginal  String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  i18n    ProjectSuccessStoryI18n[]

  @@index([projectId])
}

model ProjectSuccessStoryI18n {
  id        String   @id @default(cuid())
  storyId   String
  lang      Language
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  story ProjectSuccessStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, lang])
  @@index([storyId])
  @@index([lang])
}

//
// ✅ 추가 Models: OAuth / Repository / Calendar / Time / AI / Summary / Audit
//

// GitHub 등 OAuth 연동 정보(토큰/스코프/만료 등)
model OAuthAccount {
  id              String       @id @default(cuid())
  userId          String
  provider        AuthProvider
  providerUserId  String

  // GitHub login(username)
  username        String?

  scope           String?
  accessTokenEnc  String?      // 암호화해서 저장(권장)
  refreshTokenEnc String?
  expiresAt       DateTime?
  revokedAt       DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@index([provider])
}

// ✅ Refresh Token 세션(쿠키 기반 refresh 토큰을 서버에서 폐기/추적하기 위한 테이블)
model RefreshSession {
  id               String   @id @default(cuid())
  userId           String
  refreshTokenHash String
  expiresAt        DateTime

  userAgent        String?
  ip               String?

  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// 프로젝트와 연결된 레포(생성/초대 자동화에 필요)
model ProjectRepository {
  id             String       @id @default(cuid())
  projectId      String
  provider       RepoProvider @default(GITHUB)
  owner          String
  repoName       String
  repoUrl        String
  defaultBranch  String?      @default("main")

  // GitHub App 방식 사용 시 유용 (선택)
  installationId  String?
  createdByUserId String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([provider, owner, repoName])
  @@index([projectId])
  @@index([provider])
}

// 캘린더 이벤트(일정)
model ProjectCalendarEvent {
  id          String   @id @default(cuid())
  projectId   String
  title       String
  description String?
  startAt     DateTime
  endAt       DateTime
  isAllDay    Boolean  @default(false)
  status      String   @default("PLANNED") // 간단히 String, 필요하면 enum으로 확장
  createdById String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("ProjectCalendarEventCreator", fields: [createdById], references: [id], onDelete: SetNull)

  assignees ProjectCalendarEventAssignee[]

  @@index([projectId])
  @@index([startAt])
  @@index([endAt])
}

// 캘린더 이벤트 담당자(N:M)
model ProjectCalendarEventAssignee {
  id      String @id @default(cuid())
  eventId String
  userId  String

  event ProjectCalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// 작업 시간 추적
model TimeEntry {
  id              String   @id @default(cuid())
  projectId        String
  userId           String
  startAt          DateTime
  endAt            DateTime
  durationMinutes  Int

  // 선택: 칸반 카드와 연결
  kanbanCardId     String?

  note             String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  kanbanCard KanbanCard? @relation(fields: [kanbanCardId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([userId])
  @@index([startAt])
}

// AI 산출물(기획서/ERD/API/화면목록 등) 버전 관리
model AiArtifact {
  id             String        @id @default(cuid())
  projectId       String?
  type           AiArtifactType
  version        Int           @default(1)
  title          String?
  contentJson    Json
  revisionBaseId String?
  createdById    String?

  // 추적용 메타데이터(권장)
  modelName      String?
  promptHash     String?
  tokenUsage     Json?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User?    @relation("AiArtifactCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([type])
  @@index([revisionBaseId])
  @@unique([projectId, type, version])
}

// 프로젝트 요약/결정/액션아이템 저장(주간 요약 등)
model ProjectSummary {
  id              String        @id @default(cuid())
  projectId        String
  source           SummarySource @default(CHAT)

  periodStart      DateTime?
  periodEnd        DateTime?

  summaryText      String
  actionItemsJson  Json?

  createdById      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("ProjectSummaryCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([source])
  @@index([createdAt])
}

// 감사 로그(누가 무엇을 바꿨는지)
model AuditLog {
  id         String      @id @default(cuid())
  projectId  String?
  actorId    String?

  action     AuditAction
  entityType String      // "Project", "KanbanCard", "Invitation" ...
  entityId   String?     // 대상 id
  summary    String?     // 사람이 읽을 한 줄
  diffJson   Json?       // before/after 등

  createdAt  DateTime @default(now())

  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  actor   User?    @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([actorId])
  @@index([entityType])
  @@index([createdAt])
}
